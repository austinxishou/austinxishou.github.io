<!DOCTYPE html>
<html>
<head>
    

    

    



    <meta charset="utf-8">
    
    
    
	<meta name="baidu-site-verification" content="rK8VXMxyIo" />
    <title>Android发送广播详解 | 爵士犀首 | Stand out or get out!</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="app,sendBroadcast,android">
    <meta name="description" content="Android app sendBroadcast">
<meta property="og:type" content="article">
<meta property="og:title" content="Android发送广播详解">
<meta property="og:url" content="https://austinxishou.github.io/2017/03/31/android/Android发送广播详解/index.html">
<meta property="og:site_name" content="爵士犀首">
<meta property="og:description" content="Android app sendBroadcast">
<meta property="og:updated_time" content="2017-03-31T07:34:50.276Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android发送广播详解">
<meta name="twitter:description" content="Android app sendBroadcast">
    
        <link rel="alternative" href="/atom.xml" title="爵士犀首" type="application/atom+xml">
    
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="/css/style.css?v=1.4.14">
    <script>window.lazyScripts=[]</script>
</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">AustinXishou</h5>
          <a href="mailto:3559956089@qq.com" title="3559956089@qq.com" class="mail">3559956089@qq.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                Archives
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                Tags
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                Categories
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories/android"  >
                <i class="icon icon-lg icon-android"></i>
                Android
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories/webdesign"  >
                <i class="icon icon-lg icon-chrome"></i>
                Webdesign
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories/wechat"  >
                <i class="icon icon-lg icon-wechat"></i>
                微信开发
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories/killtime"  >
                <i class="icon icon-lg icon-coffee"></i>
                闲暇时光
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/austinxishou" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">Android发送广播详解</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">Android发送广播详解</h1>
        <h5 class="subtitle">
            
                <time datetime="2017-03-31T06:22:32.229Z" itemprop="datePublished" class="page-time">
  2017-03-31
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/android/">android</a></li></ul>

            
        </h5>
    </div>

    

</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#调用ContextImpl进行发送"><span class="post-toc-number">1.</span> <span class="post-toc-text">调用ContextImpl进行发送</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#ActivityManagerProxy发送到AMS"><span class="post-toc-number">2.</span> <span class="post-toc-text">ActivityManagerProxy发送到AMS</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#AMS处理BROADCAST-INTENT-TRANSACTION"><span class="post-toc-number">3.</span> <span class="post-toc-text">AMS处理BROADCAST_INTENT_TRANSACTION</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#broadcastIntentLocked获取目标Receivers"><span class="post-toc-number">4.</span> <span class="post-toc-text">broadcastIntentLocked获取目标Receivers</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#scheduleBroadcastsLocked调度执行"><span class="post-toc-number">5.</span> <span class="post-toc-text">scheduleBroadcastsLocked调度执行</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#处理广播"><span class="post-toc-number">6.</span> <span class="post-toc-text">处理广播</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#处理无序广播"><span class="post-toc-number">6.1.</span> <span class="post-toc-text">处理无序广播</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#BroadcastQueue-deliverToRegisteredReceiverLocked"><span class="post-toc-number">6.2.</span> <span class="post-toc-text">BroadcastQueue#deliverToRegisteredReceiverLocked</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#6-3-BroadcastQueue-performReceiveLocked"><span class="post-toc-number">6.3.</span> <span class="post-toc-text">6.3 BroadcastQueue#performReceiveLocked</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#6-4-IIntentReceiver-performReceive"><span class="post-toc-number">6.4.</span> <span class="post-toc-text">6.4 IIntentReceiver#performReceive</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#6-5-ReceiverDispatcher-performReceive"><span class="post-toc-number">6.5.</span> <span class="post-toc-text">6.5 ReceiverDispatcher#performReceive</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#6-6-Args-run"><span class="post-toc-number">6.6.</span> <span class="post-toc-text">6.6 Args#run</span></a></li></ol></li></ol>
        </nav>
    </aside>
    
<article id="post-android/Android发送广播详解"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">Android发送广播详解</h1>
        <div class="post-meta">
            <time class="post-time" title="2017年03月31日 14:22" datetime="2017-03-31T06:22:32.229Z"  itemprop="datePublished">2017-03-31</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/android/">android</a></li></ul>



            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style='display:none'>
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


            

        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <h2 id="调用ContextImpl进行发送"><a href="#调用ContextImpl进行发送" class="headerlink" title="调用ContextImpl进行发送"></a>调用ContextImpl进行发送</h2><p>同样，不管是<code>Activity</code>、<code>Service</code>上发送广播，最终实现都在<code>ContextImpl</code>，最后发送到<code>ActivityManagerService</code>处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendBroadcast</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">     warnIfCallingFromSystemProcess();</div><div class="line">     String resolvedType = intent.resolveTypeIfNeeded(getContentResolver());</div><div class="line">     <span class="keyword">try</span> &#123;</div><div class="line">         intent.prepareToLeaveProcess();</div><div class="line">         ActivityManagerNative.getDefault().broadcastIntent(</div><div class="line">             mMainThread.getApplicationThread(), intent, resolvedType, <span class="keyword">null</span>,</div><div class="line">             Activity.RESULT_OK, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, AppOpsManager.OP_NONE, <span class="keyword">false</span>, <span class="keyword">false</span>,</div><div class="line">             getUserId());</div><div class="line">     &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<h2 id="ActivityManagerProxy发送到AMS"><a href="#ActivityManagerProxy发送到AMS" class="headerlink" title="ActivityManagerProxy发送到AMS"></a>ActivityManagerProxy发送到AMS</h2><p>由<code>ActivityManagerProxy</code>发送到<code>AMS</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//resultTo：null，resultCode：-resultData：null，map：null，requiredPermission：null</span></div><div class="line"><span class="comment">//appOp：-1，serialized：false，sticky：false</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">broadcastIntent</span><span class="params">(IApplicationThread caller,</span></span></div><div class="line">        Intent intent, String resolvedType,  IIntentReceiver resultTo,</div><div class="line">        <span class="keyword">int</span> resultCode, String resultData, Bundle map,</div><div class="line">        String requiredPermission, <span class="keyword">int</span> appOp, <span class="keyword">boolean</span> serialized,</div><div class="line">        <span class="keyword">boolean</span> sticky, <span class="keyword">int</span> userId) <span class="keyword">throws</span> RemoteException</div><div class="line">&#123;</div><div class="line">    Parcel data = Parcel.obtain();</div><div class="line">    Parcel reply = Parcel.obtain();</div><div class="line">    data.writeInterfaceToken(IActivityManager.descriptor);</div><div class="line">    data.writeStrongBinder(caller != <span class="keyword">null</span> ? caller.asBinder() : <span class="keyword">null</span>);</div><div class="line">    intent.writeToParcel(data, <span class="number">0</span>);</div><div class="line">    data.writeString(resolvedType);</div><div class="line">    data.writeStrongBinder(resultTo != <span class="keyword">null</span> ? resultTo.asBinder() : <span class="keyword">null</span>);</div><div class="line">    data.writeInt(resultCode);</div><div class="line">    data.writeString(resultData);</div><div class="line">    data.writeBundle(map);</div><div class="line">    data.writeString(requiredPermission);</div><div class="line">    data.writeInt(appOp);</div><div class="line">    data.writeInt(serialized ? <span class="number">1</span> : <span class="number">0</span>);</div><div class="line">    data.writeInt(sticky ? <span class="number">1</span> : <span class="number">0</span>);</div><div class="line">    data.writeInt(userId);</div><div class="line">    mRemote.transact(BROADCAST_INTENT_TRANSACTION, data, reply, <span class="number">0</span>);</div><div class="line">    reply.readException();</div><div class="line">    <span class="keyword">int</span> res = reply.readInt();</div><div class="line">    reply.recycle();</div><div class="line">    data.recycle();</div><div class="line">    <span class="keyword">return</span> res;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="AMS处理BROADCAST-INTENT-TRANSACTION"><a href="#AMS处理BROADCAST-INTENT-TRANSACTION" class="headerlink" title="AMS处理BROADCAST_INTENT_TRANSACTION"></a>AMS处理BROADCAST_INTENT_TRANSACTION</h2><p><code>AMS</code>处理<code>BROADCAST_INTENT_TRANSACTION</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//resultTo：null，resultCode：-resultData：null，map：null，requiredPermission：null</span></div><div class="line"><span class="comment">//appOp：-1，serialized：false，sticky：false</span></div><div class="line"><span class="keyword">case</span> BROADCAST_INTENT_TRANSACTION:</div><div class="line">        &#123;</div><div class="line">            data.enforceInterface(IActivityManager.descriptor);</div><div class="line">            IBinder b = data.readStrongBinder();</div><div class="line">            IApplicationThread app =b != <span class="keyword">null</span> ? ApplicationThreadNative.asInterface(b) : <span class="keyword">null</span>;<span class="comment">//依然是Binder本地对象</span></div><div class="line">            Intent intent = Intent.CREATOR.createFromParcel(data);</div><div class="line">            String resolvedType = data.readString();</div><div class="line">            b = data.readStrongBinder();<span class="comment">//null</span></div><div class="line">            IIntentReceiver resultTo =b != <span class="keyword">null</span> ? IIntentReceiver.Stub.asInterface(b) : <span class="keyword">null</span>;<span class="comment">//null</span></div><div class="line">            <span class="keyword">int</span> resultCode = data.readInt();<span class="comment">//-1</span></div><div class="line">            String resultData = data.readString();<span class="comment">//null</span></div><div class="line">            Bundle resultExtras = data.readBundle();<span class="comment">//null</span></div><div class="line">            String perm = data.readString();<span class="comment">//null</span></div><div class="line">            <span class="keyword">int</span> appOp = data.readInt();<span class="comment">//-1</span></div><div class="line">            <span class="keyword">boolean</span> serialized = data.readInt() != <span class="number">0</span>;<span class="comment">//0</span></div><div class="line">            <span class="keyword">boolean</span> sticky = data.readInt() != <span class="number">0</span>;<span class="comment">//0</span></div><div class="line">            <span class="keyword">int</span> userId = data.readInt();</div><div class="line">            <span class="keyword">int</span> res = broadcastIntent(app, intent, resolvedType, resultTo,</div><div class="line">                    resultCode, resultData, resultExtras, perm, appOp,</div><div class="line">                    serialized, sticky, userId);</div><div class="line">            reply.writeNoException();</div><div class="line">            reply.writeInt(res);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div></pre></td></tr></table></figure></p>
<p>首先检验<code>Intent</code>的有效性，是否带文件描述符，如果进程未启动完成，带<code>FLAG_RECEIVER_REGISTERED_ONLY_BEFORE_BOOT</code>，表示可以在进程未启动完之前接收广播，没有该标识则抛异常，接着调用方法<code>broadcastIntentLocked</code>处理<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//resultTo：null，resultCode：-resultData：null，map：null，requiredPermission：null</span></div><div class="line"><span class="comment">//appOp：-1，serialized：false，sticky：false</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">broadcastIntent</span><span class="params">(IApplicationThread caller,</span></span></div><div class="line">        Intent intent, String resolvedType, IIntentReceiver resultTo,</div><div class="line">        <span class="keyword">int</span> resultCode, String resultData, Bundle map,</div><div class="line">        String requiredPermission, <span class="keyword">int</span> appOp, <span class="keyword">boolean</span> serialized, <span class="keyword">boolean</span> sticky, <span class="keyword">int</span> userId) &#123;</div><div class="line">    enforceNotIsolatedCaller(<span class="string">"broadcastIntent"</span>);</div><div class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</div><div class="line">    <span class="comment">//intent有效性检查，不能带文件描述符</span></div><div class="line">        intent = verifyBroadcastLocked(intent);</div><div class="line">        <span class="keyword">final</span> ProcessRecord callerApp = getRecordForAppLocked(caller);</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> callingPid = Binder.getCallingPid();</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> callingUid = Binder.getCallingUid();</div><div class="line">        <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</div><div class="line">        <span class="keyword">int</span> res = broadcastIntentLocked(callerApp,</div><div class="line">                callerApp != <span class="keyword">null</span> ? callerApp.info.packageName : <span class="keyword">null</span>,</div><div class="line">                intent, resolvedType, resultTo,</div><div class="line">                resultCode, resultData, map, requiredPermission, appOp, serialized, sticky,</div><div class="line">                callingPid, callingUid, userId);</div><div class="line">        Binder.restoreCallingIdentity(origId);</div><div class="line">        <span class="keyword">return</span> res;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="broadcastIntentLocked获取目标Receivers"><a href="#broadcastIntentLocked获取目标Receivers" class="headerlink" title="broadcastIntentLocked获取目标Receivers"></a>broadcastIntentLocked获取目标Receivers</h2><p>首先处理一些特殊的广播，如：接收到<code>PackageManager</code>发来的应用包移除广播，就会把所有属于该包下的<code>ActivityRecord</code>出栈等，<code>AMS</code>内有两种广播队列，分别是前台广播队列<code>mFgBroadcastQueue</code>保存带<code>FLAG_RECEIVER_FOREGROUND</code>的广播，和后台广播队列<code>mBgBroadcastQueue</code>，先会尝试向并行<code>receivers</code>递送广播，此时会调用到<code>queue.scheduleBroadcastsLocked()</code>，简单地说就是，新建一个<code>BroadcastRecord</code>节点，并插入对应的<code>BroadcastQueue</code>，最后发起实际的广播调度（<code>scheduleBroadcastsLocked()</code>），不光并行处理部分需要一个<code>BroadcastRecord</code>节点，串行处理部分也需要<code>BroadcastRecord</code>节点。也就是说，要激发一次广播，<code>AMS</code>必须构造一个或两个<code>BroadcastRecord</code>节点，并将之插入合适的广播队列。插入成功后，再执行队列的<code>scheduleBroadcastsLocked()</code>动作<br><code>BroadcastRecord</code>节点内部的<code>receivers</code>列表，记录着和这个广播动作相关的目标<code>receiver</code>信息，该列表内部的子节点可能是<code>ResolveInfo</code>类型的，也可能是<code>BroadcastFilter</code>类型的。<code>ResolveInfo</code>是从<code>PKMS</code>处查到的静态<code>receiver</code>的描述信息，它的源头是<code>PKMS</code>解析的那些<code>AndroidManifest.xml</code>文件。而<code>BroadcastFilter</code>来自于动态注册<code>receiver</code>时，保存在<code>AMS</code>成员变量<code>mReceiverResolver</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//resultTo：null，resultCode：-resultData：null，map：null，requiredPermission：null</span></div><div class="line"><span class="comment">//appOp：-1，serialized：false，sticky：false</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">broadcastIntentLocked</span><span class="params">(ProcessRecord callerApp,</span></span></div><div class="line">        String callerPackage, Intent intent, String resolvedType,</div><div class="line">        IIntentReceiver resultTo, <span class="keyword">int</span> resultCode, String resultData,</div><div class="line">        Bundle map, String requiredPermission, <span class="keyword">int</span> appOp,</div><div class="line">        <span class="keyword">boolean</span> ordered, <span class="keyword">boolean</span> sticky, <span class="keyword">int</span> callingPid, <span class="keyword">int</span> callingUid,</div><div class="line">        <span class="keyword">int</span> userId) &#123;</div><div class="line">    intent = <span class="keyword">new</span> Intent(intent);</div><div class="line"></div><div class="line">    <span class="comment">// By default broadcasts do not go to stopped apps.</span></div><div class="line">    <span class="comment">//在Android3.1之后，PKMS加强了对“处于停止状态的”应用的管理。如果一个应用在安装后从来没有启动过，或者已经被用户强制停止了，那么这个应用就处于停止状态（stoppedstate）。为了达到精细调整的目的，Android增加了2个flag：FLAG_INCLUDE_STOPPED_PACKAGES和FLAG_EXCLUDE_STOPPED_PACKAGES，以此来表示intent是否要激活“处于停止状态的”应用。而默认则是不激活</span></div><div class="line">    intent.addFlags(Intent.FLAG_EXCLUDE_STOPPED_PACKAGES);</div><div class="line"></div><div class="line">    <span class="comment">//....</span></div><div class="line"></div><div class="line">    userId = handleIncomingUser(callingPid, callingUid, userId,<span class="keyword">true</span>, <span class="keyword">false</span>, <span class="string">"broadcast"</span>, callerPackage);<span class="comment">//权限检测</span></div><div class="line"></div><div class="line">    <span class="comment">// Make sure that the user who is receiving this broadcast is started.</span></div><div class="line">    <span class="comment">// If not, we will just skip it.</span></div><div class="line">    <span class="keyword">if</span> (userId != UserHandle.USER_ALL &amp;&amp; mStartedUsers.get(userId) == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (callingUid != Process.SYSTEM_UID || (intent.getFlags()</div><div class="line">                &amp; Intent.FLAG_RECEIVER_BOOT_UPGRADE) == <span class="number">0</span>) &#123;</div><div class="line">            Slog.w(TAG, <span class="string">"Skipping broadcast of "</span> + intent+ <span class="string">": user "</span> + userId + <span class="string">" is stopped"</span>);</div><div class="line">            <span class="keyword">return</span> ActivityManager.BROADCAST_SUCCESS;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">     * Prevent non-system code (defined here to be non-persistent processes) from sending protected broadcasts.</div><div class="line">     */</div><div class="line">    <span class="keyword">int</span> callingAppId = UserHandle.getAppId(callingUid);</div><div class="line">    <span class="keyword">if</span> (callingAppId == Process.SYSTEM_UID || callingAppId == Process.PHONE_UID</div><div class="line">        || callingAppId == Process.SHELL_UID || callingAppId == Process.BLUETOOTH_UID ||</div><div class="line">        callingUid == <span class="number">0</span>) &#123;</div><div class="line">        <span class="comment">// Always okay.</span></div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (callerApp == <span class="keyword">null</span> || !callerApp.persistent) &#123;</div><div class="line">        <span class="comment">//...</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Handle special intents: if this broadcast is from the package</span></div><div class="line">    <span class="comment">// manager about a package being removed, we need to remove all of</span></div><div class="line">    <span class="comment">// its activities from the history stack.</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> uidRemoved = Intent.ACTION_UID_REMOVED.equals(intent.getAction());</div><div class="line">    <span class="keyword">if</span> (Intent.ACTION_PACKAGE_REMOVED.equals(intent.getAction())</div><div class="line">            || Intent.ACTION_PACKAGE_CHANGED.equals(intent.getAction())</div><div class="line">            || Intent.ACTION_EXTERNAL_APPLICATIONS_UNAVAILABLE.equals(intent.getAction())</div><div class="line">            || uidRemoved) &#123;</div><div class="line">        <span class="keyword">if</span> (checkComponentPermission(android.Manifest.permission.BROADCAST_PACKAGE_REMOVED,callingPid, callingUid, -<span class="number">1</span>, <span class="keyword">true</span>)</div><div class="line">                == PackageManager.PERMISSION_GRANTED) &#123;</div><div class="line">            <span class="keyword">if</span> (uidRemoved) &#123;</div><div class="line">                <span class="keyword">final</span> Bundle intentExtras = intent.getExtras();</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> uid = intentExtras != <span class="keyword">null</span></div><div class="line">                        ? intentExtras.getInt(Intent.EXTRA_UID) : -<span class="number">1</span>;</div><div class="line">                <span class="keyword">if</span> (uid &gt;= <span class="number">0</span>) &#123;</div><div class="line">                    BatteryStatsImpl bs = mBatteryStatsService.getActiveStatistics();</div><div class="line">                    <span class="keyword">synchronized</span> (bs) &#123;</div><div class="line">                        bs.removeUidStatsLocked(uid);</div><div class="line">                    &#125;</div><div class="line">                    mAppOpsService.uidRemoved(uid);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// If resources are unavailable just force stop all</span></div><div class="line">                <span class="comment">// those packages and flush the attribute cache as well.</span></div><div class="line">                <span class="keyword">if</span> (Intent.ACTION_EXTERNAL_APPLICATIONS_UNAVAILABLE.equals(intent.getAction())) &#123;</div><div class="line">                    String list[] = intent.getStringArrayExtra(Intent.EXTRA_CHANGED_PACKAGE_LIST);</div><div class="line">                    <span class="keyword">if</span> (list != <span class="keyword">null</span> &amp;&amp; (list.length &gt; <span class="number">0</span>)) &#123;</div><div class="line">                        <span class="keyword">for</span> (String pkg : list) &#123;</div><div class="line">                            forceStopPackageLocked(pkg, -<span class="number">1</span>, <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, userId,</div><div class="line">                                    <span class="string">"storage unmount"</span>);</div><div class="line">                        &#125;</div><div class="line">                        sendPackageBroadcastLocked(</div><div class="line">                                IApplicationThread.EXTERNAL_STORAGE_UNAVAILABLE, list, userId);</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    Uri data = intent.getData();</div><div class="line">                    String ssp;</div><div class="line">                    <span class="keyword">if</span> (data != <span class="keyword">null</span> &amp;&amp; (ssp=data.getSchemeSpecificPart()) != <span class="keyword">null</span>) &#123;</div><div class="line">                        <span class="keyword">boolean</span> removed = Intent.ACTION_PACKAGE_REMOVED.equals(</div><div class="line">                                intent.getAction());</div><div class="line">                        <span class="keyword">if</span> (!intent.getBooleanExtra(Intent.EXTRA_DONT_KILL_APP, <span class="keyword">false</span>)) &#123;</div><div class="line">                            forceStopPackageLocked(ssp, UserHandle.getAppId(</div><div class="line">                                    intent.getIntExtra(Intent.EXTRA_UID, -<span class="number">1</span>)), <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">true</span>,</div><div class="line">                                    <span class="keyword">false</span>, userId, removed ? <span class="string">"pkg removed"</span> : <span class="string">"pkg changed"</span>);</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">if</span> (removed) &#123;</div><div class="line">                            sendPackageBroadcastLocked(IApplicationThread.PACKAGE_REMOVED,</div><div class="line">                                    <span class="keyword">new</span> String[] &#123;ssp&#125;, userId);</div><div class="line">                            <span class="keyword">if</span> (!intent.getBooleanExtra(Intent.EXTRA_REPLACING, <span class="keyword">false</span>)) &#123;</div><div class="line">                                mAppOpsService.packageRemoved(</div><div class="line">                                        intent.getIntExtra(Intent.EXTRA_UID, -<span class="number">1</span>), ssp);</div><div class="line"></div><div class="line">                                <span class="comment">// Remove all permissions granted from/to this package</span></div><div class="line">                                removeUriPermissionsForPackageLocked(ssp, userId, <span class="keyword">true</span>);</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">//"Permission Denial: "</span></div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(msg);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Special case for adding a package: by default turn on compatibility mode.</span></div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Intent.ACTION_PACKAGE_ADDED.equals(intent.getAction())) &#123;</div><div class="line">        Uri data = intent.getData();</div><div class="line">        String ssp;</div><div class="line">        <span class="keyword">if</span> (data != <span class="keyword">null</span> &amp;&amp; (ssp=data.getSchemeSpecificPart()) != <span class="keyword">null</span>) &#123;</div><div class="line">            mCompatModePackages.handlePackageAddedLocked(ssp,</div><div class="line">                    intent.getBooleanExtra(Intent.EXTRA_REPLACING, <span class="keyword">false</span>));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">     * If this is the time zone changed action, queue up a message that will reset the timezone</div><div class="line">     * of all currently running processes. This message will get queued up before the broadcast</div><div class="line">     * happens.</div><div class="line">     */</div><div class="line">    <span class="keyword">if</span> (intent.ACTION_TIMEZONE_CHANGED.equals(intent.getAction())) &#123;</div><div class="line">        mHandler.sendEmptyMessage(UPDATE_TIME_ZONE);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (intent.ACTION_CLEAR_DNS_CACHE.equals(intent.getAction())) &#123;</div><div class="line">        mHandler.sendEmptyMessage(CLEAR_DNS_CACHE_MSG);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (Proxy.PROXY_CHANGE_ACTION.equals(intent.getAction())) &#123;</div><div class="line">        ProxyProperties proxy = intent.getParcelableExtra(<span class="string">"proxy"</span>);</div><div class="line">        mHandler.sendMessage(mHandler.obtainMessage(UPDATE_HTTP_PROXY_MSG, proxy));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Add to the sticky list if requested.</span></div><div class="line">    <span class="keyword">if</span> (sticky) &#123;<span class="comment">//false，先忽略</span></div><div class="line">        <span class="keyword">if</span> (checkPermission(android.Manifest.permission.BROADCAST_STICKY,callingPid, callingUid)</div><div class="line">                != PackageManager.PERMISSION_GRANTED) &#123;</div><div class="line">                  <span class="comment">//...</span></div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(msg);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (requiredPermission != <span class="keyword">null</span>) &#123;</div><div class="line">            Slog.w(TAG, <span class="string">"Can't broadcast sticky intent "</span> + intent+ <span class="string">" and enforce permission "</span> + requiredPermission);</div><div class="line">            <span class="keyword">return</span> ActivityManager.BROADCAST_STICKY_CANT_HAVE_PERMISSION;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (intent.getComponent() != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Sticky broadcasts can't target a specific component"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// We use userId directly here, since the "all" target is maintained</span></div><div class="line">        <span class="comment">// as a separate set of sticky broadcasts.</span></div><div class="line">        <span class="keyword">if</span> (userId != UserHandle.USER_ALL) &#123;</div><div class="line">            <span class="comment">// But first, if this is not a broadcast to all users, then</span></div><div class="line">            <span class="comment">// make sure it doesn't conflict with an existing broadcast to</span></div><div class="line">            <span class="comment">// all users.</span></div><div class="line">            ArrayMap&lt;String, ArrayList&lt;Intent&gt;&gt; stickies = mStickyBroadcasts.get(</div><div class="line">                    UserHandle.USER_ALL);</div><div class="line">            <span class="keyword">if</span> (stickies != <span class="keyword">null</span>) &#123;</div><div class="line">                ArrayList&lt;Intent&gt; list = stickies.get(intent.getAction());</div><div class="line">                <span class="keyword">if</span> (list != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">int</span> N = list.size();</div><div class="line">                    <span class="keyword">int</span> i;</div><div class="line">                    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</div><div class="line">                        <span class="keyword">if</span> (intent.filterEquals(list.get(i))) &#123;</div><div class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</div><div class="line">                                    <span class="string">"Sticky broadcast "</span> + intent + <span class="string">" for user "</span></div><div class="line">                                    + userId + <span class="string">" conflicts with existing global broadcast"</span>);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        ArrayMap&lt;String, ArrayList&lt;Intent&gt;&gt; stickies = mStickyBroadcasts.get(userId);</div><div class="line">        <span class="keyword">if</span> (stickies == <span class="keyword">null</span>) &#123;</div><div class="line">            stickies = <span class="keyword">new</span> ArrayMap&lt;String, ArrayList&lt;Intent&gt;&gt;();</div><div class="line">            mStickyBroadcasts.put(userId, stickies);</div><div class="line">        &#125;</div><div class="line">        ArrayList&lt;Intent&gt; list = stickies.get(intent.getAction());</div><div class="line">        <span class="keyword">if</span> (list == <span class="keyword">null</span>) &#123;</div><div class="line">            list = <span class="keyword">new</span> ArrayList&lt;Intent&gt;();</div><div class="line">            stickies.put(intent.getAction(), list);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">int</span> N = list.size();</div><div class="line">        <span class="keyword">int</span> i;</div><div class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</div><div class="line">            <span class="keyword">if</span> (intent.filterEquals(list.get(i))) &#123;</div><div class="line">                <span class="comment">// This sticky already exists, replace it.</span></div><div class="line">                list.set(i, <span class="keyword">new</span> Intent(intent));</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (i &gt;= N) &#123;</div><div class="line">            list.add(<span class="keyword">new</span> Intent(intent));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">int</span>[] users;</div><div class="line">    <span class="keyword">if</span> (userId == UserHandle.USER_ALL) &#123;</div><div class="line">        <span class="comment">// Caller wants broadcast to go to all started users.</span></div><div class="line">        users = mStartedUserArray;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// Caller wants broadcast to go to one specific user.</span></div><div class="line">        users = <span class="keyword">new</span> <span class="keyword">int</span>[] &#123;userId&#125;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Figure out who all will receive this broadcast.</span></div><div class="line">    List receivers = <span class="keyword">null</span>;</div><div class="line">    List&lt;BroadcastFilter&gt; registeredReceivers = <span class="keyword">null</span>;</div><div class="line">    <span class="comment">// Need to resolve the intent to interested receivers...</span></div><div class="line">    <span class="comment">//FLAG_RECEIVER_REGISTERED_ONLY标识标识的是动态注册的广播，至于静态注册的广播是通过PackageManager获得</span></div><div class="line">    <span class="keyword">if</span> ((intent.getFlags()&amp;Intent.FLAG_RECEIVER_REGISTERED_ONLY)== <span class="number">0</span>) &#123;</div><div class="line">        receivers = collectReceiverComponents(intent, resolvedType, users);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (intent.getComponent() == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">//找到符合的接受者（详细之后再看），返回结果按照优先级排序</span></div><div class="line">        registeredReceivers = mReceiverResolver.queryIntent(intent,resolvedType, <span class="keyword">false</span>, userId);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//是否替代</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> replacePending =(intent.getFlags()&amp;Intent.FLAG_RECEIVER_REPLACE_PENDING) != <span class="number">0</span>;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">int</span> NR = registeredReceivers != <span class="keyword">null</span> ? registeredReceivers.size() : <span class="number">0</span>;</div><div class="line">    <span class="keyword">if</span> (!ordered &amp;&amp; NR &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="comment">// If we are not serializing this broadcast, then send the</span></div><div class="line">        <span class="comment">// registered receivers separately so they don't wait for the</span></div><div class="line">        <span class="comment">// components to be launched.</span></div><div class="line">        <span class="keyword">final</span> BroadcastQueue queue = broadcastQueueForIntent(intent);</div><div class="line">        BroadcastRecord r = <span class="keyword">new</span> BroadcastRecord(queue, intent, callerApp,</div><div class="line">                callerPackage, callingPid, callingUid, resolvedType, requiredPermission,</div><div class="line">                appOp, registeredReceivers, resultTo, resultCode, resultData, map,</div><div class="line">                ordered, sticky, <span class="keyword">false</span>, userId);</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> replaced = replacePending &amp;&amp; queue.replaceParallelBroadcastLocked(r);</div><div class="line">        <span class="keyword">if</span> (!replaced) &#123;</div><div class="line">            queue.enqueueParallelBroadcastLocked(r);</div><div class="line">            queue.scheduleBroadcastsLocked();<span class="comment">//</span></div><div class="line">        &#125;</div><div class="line">        <span class="comment">//上面完成了无序广播的调度</span></div><div class="line">        registeredReceivers = <span class="keyword">null</span>;</div><div class="line">        NR = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//看来是先处理动态注册的，之后才是静态注册的</span></div><div class="line">    <span class="comment">// Merge into one list.</span></div><div class="line">    <span class="keyword">int</span> ir = <span class="number">0</span>;</div><div class="line">    <span class="comment">//receiver记录的是在清单文件夹静态注册的广播</span></div><div class="line">    <span class="keyword">if</span> (receivers != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// A special case for PACKAGE_ADDED: do not allow the package</span></div><div class="line">        <span class="comment">// being added to see this broadcast.  This prevents them from</span></div><div class="line">        <span class="comment">// using this as a back door to get run as soon as they are</span></div><div class="line">        <span class="comment">// installed.  Maybe in the future we want to have a special install</span></div><div class="line">        <span class="comment">// broadcast or such for apps, but we'd like to deliberately make</span></div><div class="line">        <span class="comment">// this decision.</span></div><div class="line">        <span class="comment">//防止监听自己的应用安装后自己收到广播而自动启动</span></div><div class="line">        String skipPackages[] = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (Intent.ACTION_PACKAGE_ADDED.equals(intent.getAction())</div><div class="line">                || Intent.ACTION_PACKAGE_RESTARTED.equals(intent.getAction())</div><div class="line">                || Intent.ACTION_PACKAGE_DATA_CLEARED.equals(intent.getAction())) &#123;</div><div class="line">            Uri data = intent.getData();</div><div class="line">            <span class="keyword">if</span> (data != <span class="keyword">null</span>) &#123;</div><div class="line">                String pkgName = data.getSchemeSpecificPart();</div><div class="line">                <span class="keyword">if</span> (pkgName != <span class="keyword">null</span>) &#123;</div><div class="line">                    skipPackages = <span class="keyword">new</span> String[] &#123; pkgName &#125;;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Intent.ACTION_EXTERNAL_APPLICATIONS_AVAILABLE.equals(intent.getAction())) &#123;</div><div class="line">            skipPackages = intent.getStringArrayExtra(Intent.EXTRA_CHANGED_PACKAGE_LIST);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//移除特定的广播任务</span></div><div class="line">        <span class="keyword">if</span> (skipPackages != <span class="keyword">null</span> &amp;&amp; (skipPackages.length &gt; <span class="number">0</span>)) &#123;</div><div class="line">            <span class="keyword">for</span> (String skipPackage : skipPackages) &#123;</div><div class="line">                <span class="keyword">if</span> (skipPackage != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">int</span> NT = receivers.size();</div><div class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> it=<span class="number">0</span>; it&lt;NT; it++) &#123;</div><div class="line">                        ResolveInfo curt = (ResolveInfo)receivers.get(it);</div><div class="line">                        <span class="keyword">if</span> (curt.activityInfo.packageName.equals(skipPackage)) &#123;</div><div class="line">                            receivers.remove(it);</div><div class="line">                            it--;</div><div class="line">                            NT--;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//如果是无序广播，在上面NR已置为了0，下面是用于合并有序和静态注册的广播</span></div><div class="line">        <span class="keyword">int</span> NT = receivers != <span class="keyword">null</span> ? receivers.size() : <span class="number">0</span>;<span class="comment">//静态注册的广播数量</span></div><div class="line">        <span class="keyword">int</span> it = <span class="number">0</span>;</div><div class="line">        ResolveInfo curt = <span class="keyword">null</span>;</div><div class="line">        BroadcastFilter curr = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">while</span> (it &lt; NT &amp;&amp; ir &lt; NR) &#123;</div><div class="line">            <span class="keyword">if</span> (curt == <span class="keyword">null</span>) &#123;</div><div class="line">                curt = (ResolveInfo)receivers.get(it);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (curr == <span class="keyword">null</span>) &#123;</div><div class="line">                curr = registeredReceivers.get(ir);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (curr.getPriority() &gt;= curt.priority) &#123;</div><div class="line">                <span class="comment">// Insert this broadcast record into the final list.</span></div><div class="line">                receivers.add(it, curr);</div><div class="line">                ir++;</div><div class="line">                curr = <span class="keyword">null</span>;</div><div class="line">                it++;</div><div class="line">                NT++;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// Skip to the next ResolveInfo in the final list.</span></div><div class="line">                it++;</div><div class="line">                curt = <span class="keyword">null</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">while</span> (ir &lt; NR) &#123;</div><div class="line">        <span class="keyword">if</span> (receivers == <span class="keyword">null</span>) &#123;</div><div class="line">            receivers = <span class="keyword">new</span> ArrayList();</div><div class="line">        &#125;</div><div class="line">        receivers.add(registeredReceivers.get(ir));</div><div class="line">        ir++;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//下面的操作和处理无序广播一样</span></div><div class="line">    <span class="keyword">if</span> ((receivers != <span class="keyword">null</span> &amp;&amp; receivers.size() &gt; <span class="number">0</span>)|| resultTo != <span class="keyword">null</span>) &#123;</div><div class="line">        BroadcastQueue queue = broadcastQueueForIntent(intent);</div><div class="line">        <span class="comment">//resultTo：null，resultCode：-resultData：null，map：null，requiredPermission：null</span></div><div class="line">        <span class="comment">//appOp：-1，serialized：false，sticky：false</span></div><div class="line">        BroadcastRecord r = <span class="keyword">new</span> BroadcastRecord(queue, intent, callerApp,</div><div class="line">                callerPackage, callingPid, callingUid, resolvedType,</div><div class="line">                requiredPermission, appOp, receivers, resultTo, resultCode,</div><div class="line">                resultData, map, ordered, sticky, <span class="keyword">false</span>, userId);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">boolean</span> replaced = replacePending &amp;&amp; queue.replaceOrderedBroadcastLocked(r);</div><div class="line">        <span class="keyword">if</span> (!replaced) &#123;</div><div class="line">            queue.enqueueOrderedBroadcastLocked(r);</div><div class="line">            queue.scheduleBroadcastsLocked();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> ActivityManager.BROADCAST_SUCCESS;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="scheduleBroadcastsLocked调度执行"><a href="#scheduleBroadcastsLocked调度执行" class="headerlink" title="scheduleBroadcastsLocked调度执行"></a>scheduleBroadcastsLocked调度执行</h2><p>以上不管是处理有序广播还是无序广播，最重要的无疑是<code>scheduleBroadcastsLocked</code>方法调用<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">BroadcastQueue.<span class="function">java</span></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scheduleBroadcastsLocked</span><span class="params">()</span> &#123;</div><div class="line">       <span class="keyword">if</span> (mBroadcastsScheduled) &#123;</div><div class="line">           <span class="keyword">return</span>;</div><div class="line">       &#125;</div><div class="line">       mHandler.sendMessage(mHandler.obtainMessage(BROADCAST_INTENT_MSG, <span class="keyword">this</span>));</div><div class="line">       mBroadcastsScheduled = <span class="keyword">true</span>;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>处理<code>BROADCAST_TIMEOUT_MSG</code>消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">BroadcastQueue.java</div><div class="line"></div><div class="line"><span class="keyword">case</span> BROADCAST_INTENT_MSG: &#123;</div><div class="line">    processNextBroadcast(<span class="keyword">true</span>);</div><div class="line">&#125; <span class="keyword">break</span>;</div></pre></td></tr></table></figure>
<h2 id="处理广播"><a href="#处理广播" class="headerlink" title="处理广播"></a>处理广播</h2><p>所有的静态<code>receiver</code>都是串行处理的，而动态<code>receiver</code>则会按照发广播时指定的方式，进行“并行”或“串行”处理。能够并行处理的广播，其对应的若干<code>receiver</code>一定都已经存在了，不会牵扯到启动新进程的操作，所以可以在一个<code>while</code>循环中，一次性全部<code>deliver</code>。而有序广播，则需要一个一个地处理，其滚动处理的手段是发送事件，也就是说，在一个<code>receiver</code>处理完毕后，会利用广播队列（<code>BroadcastQueue</code>）的<code>mHandler</code>，发送一个<code>BROADCAST_INTENT_MSG</code>事件，从而执行下一次的<code>processNextBroadcast</code>的调度</p>
<h3 id="处理无序广播"><a href="#处理无序广播" class="headerlink" title="处理无序广播"></a>处理无序广播</h3><p>遍历并行列表（<code>mParallelBroadcasts</code>）的每一个<code>BroadcastRecord</code>以及其中的<code>receivers</code>列表。对于无序广播而言，<code>receivers</code>列表中的每个子节点是个<code>BroadcastFilter</code>。我们直接通过方法<code>deliverToRegisteredReceiverLocked</code>将广播递送出去即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">processNextBroadcast</span><span class="params">(<span class="keyword">boolean</span> fromMsg)</span> </span>&#123;</div><div class="line">    <span class="keyword">synchronized</span>(mService) &#123;</div><div class="line">        BroadcastRecord r;</div><div class="line"></div><div class="line">        mService.updateCpuStats();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (fromMsg) &#123;</div><div class="line">          <span class="comment">//表示BROADCAST_INTENT_MSG消息已经处理完了</span></div><div class="line">            mBroadcastsScheduled = <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// First, deliver any non-serialized broadcasts right away.</span></div><div class="line">        <span class="keyword">while</span> (mParallelBroadcasts.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">//BroadcastRecord类型的r内部记录了该广播的所有接收者</span></div><div class="line">            r = mParallelBroadcasts.remove(<span class="number">0</span>);</div><div class="line">            r.dispatchTime = SystemClock.uptimeMillis();</div><div class="line">            r.dispatchClockTime = System.currentTimeMillis();</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> N = r.receivers.size();<span class="comment">//接收者数量</span></div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</div><div class="line">                Object target = r.receivers.get(i);</div><div class="line">                <span class="comment">//把非有序队列中各个广播发送给广播接收者</span></div><div class="line">                deliverToRegisteredReceiverLocked(r, (BroadcastFilter)target, <span class="keyword">false</span>);</div><div class="line">            &#125;</div><div class="line">            addBroadcastToHistoryLocked(r);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//.......</span></div><div class="line">      &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h3 id="BroadcastQueue-deliverToRegisteredReceiverLocked"><a href="#BroadcastQueue-deliverToRegisteredReceiverLocked" class="headerlink" title="BroadcastQueue#deliverToRegisteredReceiverLocked"></a>BroadcastQueue#deliverToRegisteredReceiverLocked</h3><p>先进行的权限判断、操作的检测、目标进程是否启动等操作，如果都OK，前面可知<code>BroadcastFilter</code>用来关联了动态注册的<code>IIntentReceiver</code>和<code>IntentFilter</code>,所以拿到一个<code>BroadcastFilter</code>接可以知道宿主<code>IIntentReceiver</code>，最后调用<code>performReceiveLocked</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//order=false；</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">deliverToRegisteredReceiverLocked</span><span class="params">(BroadcastRecord r,BroadcastFilter filter, <span class="keyword">boolean</span> ordered)</span> </span>&#123;</div><div class="line">    <span class="keyword">boolean</span> skip = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">if</span> (filter.requiredPermission != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">int</span> perm = mService.checkComponentPermission(filter.requiredPermission,r.callingPid, r.callingUid, -<span class="number">1</span>, <span class="keyword">true</span>);</div><div class="line">        <span class="keyword">if</span> (perm != PackageManager.PERMISSION_GRANTED) &#123;</div><div class="line">            <span class="comment">//Permission Denial: broadcasting</span></div><div class="line">            skip = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (!skip &amp;&amp; r.requiredPermission != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">int</span> perm = mService.checkComponentPermission(r.requiredPermission,</div><div class="line">                filter.receiverList.pid, filter.receiverList.uid, -<span class="number">1</span>, <span class="keyword">true</span>);</div><div class="line">        <span class="keyword">if</span> (perm != PackageManager.PERMISSION_GRANTED) &#123;</div><div class="line">            <span class="comment">//Permission Denial: receiving</span></div><div class="line">            skip = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (r.appOp != AppOpsManager.OP_NONE) &#123;</div><div class="line">        <span class="keyword">int</span> mode = mService.mAppOpsService.noteOperation(r.appOp,</div><div class="line">                filter.receiverList.uid, filter.packageName);</div><div class="line">        <span class="keyword">if</span> (mode != AppOpsManager.MODE_ALLOWED) &#123;</div><div class="line">            <span class="keyword">if</span> (DEBUG_BROADCAST)  Slog.v(TAG,</div><div class="line">                    <span class="string">"App op "</span> + r.appOp + <span class="string">" not allowed for broadcast to uid "</span></div><div class="line">                    + filter.receiverList.uid + <span class="string">" pkg "</span> + filter.packageName);</div><div class="line">            skip = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (!skip) &#123;</div><div class="line">        skip = !mService.mIntentFirewall.checkBroadcast(r.intent, r.callingUid,</div><div class="line">                r.callingPid, r.resolvedType, filter.receiverList.uid);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (filter.receiverList.app == <span class="keyword">null</span> || filter.receiverList.app.crashing) &#123;</div><div class="line">        Slog.w(TAG, <span class="string">"Skipping deliver ["</span> + mQueueName + <span class="string">"] "</span> + r+ <span class="string">" to "</span> + filter.receiverList + <span class="string">": process crashing"</span>);</div><div class="line">        skip = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!skip) &#123;</div><div class="line">        <span class="comment">// If this is not being sent as an ordered broadcast, then we</span></div><div class="line">        <span class="comment">// don't want to touch the fields that keep track of the current</span></div><div class="line">        <span class="comment">// state of ordered broadcasts.</span></div><div class="line">        <span class="keyword">if</span> (ordered) &#123;<span class="comment">//false</span></div><div class="line">            r.receiver = filter.receiverList.receiver.asBinder();<span class="comment">//记录的是IIntentReceiver的Binder本地对象</span></div><div class="line">            r.curFilter = filter;</div><div class="line">            filter.receiverList.curBroadcast = r;</div><div class="line">            r.state = BroadcastRecord.CALL_IN_RECEIVE;</div><div class="line">            <span class="keyword">if</span> (filter.receiverList.app != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="comment">// Bump hosting application to no longer be in background scheduling class.  Note that we can't do that if there</span></div><div class="line">                <span class="comment">// isn't an app...  but we can only be in that case for things that directly call the IActivityManager API, which</span></div><div class="line">                <span class="comment">// are already core system stuff so don't matter for this.</span></div><div class="line">                r.curApp = filter.receiverList.app;</div><div class="line">                filter.receiverList.app.curReceiver = r;</div><div class="line">                mService.updateOomAdjLocked(r.curApp, <span class="keyword">true</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">          <span class="comment">//filter.receiverList.app:ApplicationThread</span></div><div class="line">          <span class="comment">//filter.receiverList.receiver：</span></div><div class="line">            performReceiveLocked(filter.receiverList.app, filter.receiverList.receiver,</div><div class="line">                <span class="keyword">new</span> Intent(r.intent), r.resultCode, r.resultData,</div><div class="line">                r.resultExtras, r.ordered, r.initialSticky, r.userId);</div><div class="line">            <span class="keyword">if</span> (ordered) &#123;</div><div class="line">                r.state = BroadcastRecord.CALL_DONE_RECEIVE;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">            Slog.w(TAG, <span class="string">"Failure sending broadcast "</span> + r.intent, e);</div><div class="line">            <span class="keyword">if</span> (ordered) &#123;</div><div class="line">                r.receiver = <span class="keyword">null</span>;</div><div class="line">                r.curFilter = <span class="keyword">null</span>;</div><div class="line">                filter.receiverList.curBroadcast = <span class="keyword">null</span>;</div><div class="line">                <span class="keyword">if</span> (filter.receiverList.app != <span class="keyword">null</span>) &#123;</div><div class="line">                    filter.receiverList.app.curReceiver = <span class="keyword">null</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="6-3-BroadcastQueue-performReceiveLocked"><a href="#6-3-BroadcastQueue-performReceiveLocked" class="headerlink" title="6.3 BroadcastQueue#performReceiveLocked"></a>6.3 BroadcastQueue#performReceiveLocked</h3><p>接着如果当前进程是存在的且已经启动，通过<code>ApplicationThread</code>来进行回调但实际上还是通过<code>IIntentReceiver</code>来回调，<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">BroadcastQueue.<span class="function">java</span></div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">performReceiveLocked</span><span class="params">(ProcessRecord app, IIntentReceiver receiver,</span></div><div class="line">        Intent intent, <span class="keyword">int</span> resultCode, String data, Bundle extras,</div><div class="line">        <span class="keyword">boolean</span> ordered, <span class="keyword">boolean</span> sticky, <span class="keyword">int</span> sendingUser) <span class="keyword">throws</span> RemoteException &#123;</div><div class="line">    <span class="comment">// Send the intent to the receiver asynchronously using one-way binder calls.</span></div><div class="line">    <span class="keyword">if</span> (app != <span class="keyword">null</span> &amp;&amp; app.thread != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// If we have an app thread, do the call through that so it is correctly ordered with other one-way calls.</span></div><div class="line">        app.thread.scheduleRegisteredReceiver(receiver, intent, resultCode,</div><div class="line">                data, extras, ordered, sticky, sendingUser, app.repProcState);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        receiver.performReceive(intent, resultCode, data, extras, ordered,</div><div class="line">                sticky, sendingUser);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="6-4-IIntentReceiver-performReceive"><a href="#6-4-IIntentReceiver-performReceive" class="headerlink" title="6.4 IIntentReceiver#performReceive"></a>6.4 IIntentReceiver#performReceive</h3><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">LoadedApk#ReceiverDispatcher#IIntentReceiver</div><div class="line"></div><div class="line">public void performReceive(Intent intent, int resultCode, String data,</div><div class="line">                    Bundle extras, boolean ordered, boolean sticky, int sendingUser) &#123;</div><div class="line">                //获取宿主ReceiverDispatcher</div><div class="line">                LoadedApk.ReceiverDispatcher rd = mDispatcher.get();</div><div class="line"></div><div class="line">                if (rd != null) &#123;</div><div class="line">                    rd.performReceive(intent, resultCode, data, extras,ordered, sticky, sendingUser);</div><div class="line">                &#125; else &#123;</div><div class="line">                    // The activity manager dispatched a broadcast to a registered</div><div class="line">                    // receiver in this process, but before it could be delivered the</div><div class="line">                    // receiver was unregistered.  Acknowledge the broadcast on its</div><div class="line">                    // behalf so that the system's broadcast sequence can continue.</div><div class="line">                    if (ActivityThread.DEBUG_BROADCAST) Slog.i(ActivityThread.TAG,"Finishing broadcast to unregistered receiver");</div><div class="line">                    IActivityManager mgr = ActivityManagerNative.getDefault();</div><div class="line">                    try &#123;</div><div class="line">                        if (extras != null) &#123;</div><div class="line">                            extras.setAllowFds(false);</div><div class="line">                        &#125;</div><div class="line">                        mgr.finishReceiver(this, resultCode, data, extras, false);</div><div class="line">                    &#125; catch (RemoteException e) &#123;</div><div class="line">                        Slog.w(ActivityThread.TAG, "Couldn't finish broadcast to unregistered receiver");</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div></pre></td></tr></table></figure>
<h3 id="6-5-ReceiverDispatcher-performReceive"><a href="#6-5-ReceiverDispatcher-performReceive" class="headerlink" title="6.5 ReceiverDispatcher#performReceive"></a>6.5 ReceiverDispatcher#performReceive</h3><p>构造<code>Args</code>封装成一个消息,<code>Args</code>继承自<code>PendingResult</code>实现了<code>Runnable</code>接口<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">LoadedApk#ReceiverDispatcher</div><div class="line"></div><div class="line">public void performReceive(Intent intent, int resultCode, String data,</div><div class="line">        Bundle extras, boolean ordered, boolean sticky, int sendingUser) &#123;</div><div class="line"></div><div class="line">    Args args = new Args(intent, resultCode, data, extras, ordered,sticky, sendingUser);</div><div class="line">    if (!mActivityThread.post(args)) &#123;</div><div class="line">        if (mRegistered &amp;&amp; ordered) &#123;</div><div class="line">            IActivityManager mgr = ActivityManagerNative.getDefault();</div><div class="line"></div><div class="line">            args.sendFinished(mgr);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="6-6-Args-run"><a href="#6-6-Args-run" class="headerlink" title="6.6 Args#run"></a>6.6 Args#run</h3><p>但是构造一个<code>Args</code>对象又有什么用？或者说<code>PendingResult</code>的作用是什么？这个<code>PendingResult</code>可以在<code>BroadcastReceiver#onReceive</code>方法中通过<code>goAsync</code>方法返回，表示的结果的状态，在一个广播处理完之后必须调用其<code>finish</code>方法（这个在回调<code>onReceiver</code>方法后会自动回调）,<code>finish</code>方法用来完成某个广播，对于一个已经处理完的广播，如果是有序广播，接收完之后需要向<code>AMS</code>发一个回包，以便<code>AMS</code>可以将这个有序广播发送给下一个广播接收者。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Args</span> <span class="keyword">extends</span> <span class="title">BroadcastReceiver</span>.<span class="title">PendingResult</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> Intent mCurIntent;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> mOrdered;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Args</span><span class="params">(Intent intent, <span class="keyword">int</span> resultCode, String resultData, Bundle resultExtras,</span></span></div><div class="line">            <span class="keyword">boolean</span> ordered, <span class="keyword">boolean</span> sticky, <span class="keyword">int</span> sendingUser) &#123;</div><div class="line">        <span class="keyword">super</span>(resultCode, resultData, resultExtras,</div><div class="line">                mRegistered ? TYPE_REGISTERED : TYPE_UNREGISTERED,</div><div class="line">                ordered, sticky, mIIntentReceiver.asBinder(), sendingUser);</div><div class="line">        mCurIntent = intent;</div><div class="line">        mOrdered = ordered;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> BroadcastReceiver receiver = mReceiver;<span class="comment">//具体注册的BroadcastReceiver，保存在ReceiverDispatcher成员变量</span></div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> ordered = mOrdered;</div><div class="line"></div><div class="line"></div><div class="line">        <span class="keyword">final</span> IActivityManager mgr = ActivityManagerNative.getDefault();</div><div class="line">        <span class="keyword">final</span> Intent intent = mCurIntent;</div><div class="line">        mCurIntent = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (receiver == <span class="keyword">null</span> || mForgotten) &#123;</div><div class="line">            <span class="keyword">if</span> (mRegistered &amp;&amp; ordered) &#123;</div><div class="line">                sendFinished(mgr);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            ClassLoader cl =  mReceiver.getClass().getClassLoader();</div><div class="line">            intent.setExtrasClassLoader(cl);</div><div class="line">            setExtrasClassLoader(cl);</div><div class="line">            receiver.setPendingResult(<span class="keyword">this</span>);</div><div class="line">            receiver.onReceive(mContext, intent);<span class="comment">//回调具体的Receiver</span></div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            <span class="keyword">if</span> (mRegistered &amp;&amp; ordered) &#123;</div><div class="line">                <span class="keyword">if</span> (ActivityThread.DEBUG_BROADCAST) Slog.i(ActivityThread.TAG,<span class="string">"Finishing failed broadcast to "</span> + mReceiver);</div><div class="line">                sendFinished(mgr);</div><div class="line">            &#125;</div><div class="line">              <span class="comment">//...</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (receiver.getPendingResult() != <span class="keyword">null</span>) &#123;</div><div class="line">            finish();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

        </div>

        <blockquote class="post-copyright">
    <div class="content">
        
<span class="post-time">
    最后更新时间：<time datetime="2017-03-31T07:34:50.276Z" itemprop="dateUpdated">2017年3月31日 15:34</time>
</span><br>


        欢迎转载,但请申明原链接：<a href="/2017/03/31/android/Android发送广播详解/" target="_blank" rel="external">https://austinxishou.github.io/2017/03/31/android/Android发送广播详解/</a>
    </div>
    <footer>
        <a href="https://austinxishou.github.io">
            <img src="/img/avatar.jpg" alt="AustinXishou">
            AustinXishou
        </a>
    </footer>
</blockquote>

        
<div class="page-reward">
    <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-circle waves-light">赏</a>
</div>



        <div class="post-footer">
            
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/android/">android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/app/">app</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/sendBroadcast/">sendBroadcast</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://austinxishou.github.io/2017/03/31/android/Android发送广播详解/&title=《Android发送广播详解》 — 爵士犀首&pic=https://austinxishou.github.io/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://austinxishou.github.io/2017/03/31/android/Android发送广播详解/&title=《Android发送广播详解》 — 爵士犀首&source=Personal blog" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://austinxishou.github.io/2017/03/31/android/Android发送广播详解/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《Android发送广播详解》 — 爵士犀首&url=https://austinxishou.github.io/2017/03/31/android/Android发送广播详解/&via=https://austinxishou.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://austinxishou.github.io/2017/03/31/android/Android发送广播详解/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/2017/03/31/android/Android自启动管理功能/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">Android自启动管理功能</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/2017/03/29/android/SEAndroid权限修改/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">SEAndroid权限修改</h4>
      </a>
    </div>
  
</nav>



    

<div class="comments" id="comments">
    <div class="ds-thread" data-thread-key="android/Android发送广播详解" data-title="Android发送广播详解" data-url="https://austinxishou.github.io/2017/03/31/android/Android发送广播详解/"></div>
</div>
<script>
lazyScripts.push('//cdn.bootcss.com/marked/0.3.6/marked.min.js');

var duoshuoQuery = {short_name:'ysblog', theme: 'none'};
lazyScripts.push('/js/embed.min.js?v=1.4.14');


</script>










</article>

<div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        谢谢大爷,欢迎再来~
        <i class="icon icon-quote-right"></i>
    </h3>
    <ul class="reward-items">
        
        <li>
            <img src="/img/wechatpay.jpg" title="微信打赏二维码" alt="微信打赏二维码">
            <p>微信</p>
        </li>
        

        
        <li>
            <img src="/img/alipay.jpg" title="支付宝打赏二维码" alt="支付宝打赏二维码">
            <p>支付宝</p>
        </li>
        
    </ul>
</div>



</div>

        <footer class="footer">
    <div class="top">
        
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        站点总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        站点总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


        <p>
            <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
            <span>博客内容遵循 <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">知识共享 署名 - 非商业性 - 相同方式共享 4.0协议</a></span>
        </p>
    </div>
    <div class="bottom">
        <p>
            <span>Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a></span>
            <span>爵士犀首 &copy; 2016 - 2017</span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://austinxishou.github.io/2017/03/31/android/Android发送广播详解/&title=《Android发送广播详解》 — 爵士犀首&pic=https://austinxishou.github.io/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://austinxishou.github.io/2017/03/31/android/Android发送广播详解/&title=《Android发送广播详解》 — 爵士犀首&source=Personal blog" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://austinxishou.github.io/2017/03/31/android/Android发送广播详解/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《Android发送广播详解》 — 爵士犀首&url=https://austinxishou.github.io/2017/03/31/android/Android发送广播详解/&via=https://austinxishou.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://austinxishou.github.io/2017/03/31/android/Android发送广播详解/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAN4AAADeCAAAAAB3DOFrAAACwElEQVR42u3aQY7CMAwFUO5/aWY7EkP530mAkV5XqJSS10Xs2r7d4uP+63h2/vGa6zOP5x/vfP3v2w48PDy8haXnC71e1rOlt3e4vs/1mvHw8PBO857tqPnnPGDMAkD+v3h4eHjfxku26TzXvV5DEmzw8PDw/juvDS1Jev1FgQEPDw+vLEYkW3xeYsjDSVIO3lBrwcPDw5vcp05/P/X5SH8PDw8Pb7mr3g4E5AGj3dbvowMPDw/vBC/fcPNG/sri1tNlPDw8vNO8fKQpHxTIzyePKfn26a/w8PDwDvCSn7XNsCIixQNY7WMqasB4eHh4JW9WPF0pPcwCTJum4+Hh4Z3j5UNU+XDAbIiqbXHVjTE8PDy8TbykfJAktXlISAJGm0a/6O/h4eHhHeDl2/Fs+ClplSUtsTahx8PDwzvB2/WqP2uktYuePRo8PDy8d/La8LArQd+VsuPh4eGd5uVNqVn7apYizwYa8PDw8M7x2kHSWSl2V9ioDzw8PLwDvLyx1BYpkiLCLAAkpRM8PDy807w22c1b+LOybF6MiK7Hw8PD28pr09w8FU4KB/k1w1QeDw8P70O8WYur3eLr9n/StMPDw8M7xms3/WHmfri1hoeHh/ce3kprKnk0s7vNysRL0Q8PDw9vgbdSUMgT9Lzgm6fgRZUaDw8P7xhvfYqpLXmstNzqheLh4eEt8/JG1CwAtOn19X8VIwt4eHh4x3htUz8pDewq4N7Ko3hjwMPDwyt5s0JqW57Im2p5eSIqcODh4eEd4LVbbZ74ts2qleA0Cx54eHh4K7w2GMyWnpd318e//nhjwMPDwzvAa5feDhbMkuO6soKHh4f3lbz1Nli79edDBi8aYHh4eHhfycsLsm0anb8A4OHh4b2H17as8sGsJEVeL3xEM2V4eHh4m3izF/6835R8m1y5gYGHh4e3yvsBF99zqPzhz3cAAAAASUVORK5CYII=" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: true };



</script>

<script src="/js/main.min.js?v=1.4.14"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="/js/search.min.js?v=1.4.14" async></script>






<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>



<script>
(function() {
    var OriginTitile = document.title, titleTime;
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            document.title = '死鬼去哪里了！';
            clearTimeout(titleTime);
        } else {
            document.title = '咦!又好了!';
            titleTime = setTimeout(function() {
                document.title = OriginTitile;
            },2000);
        }
    });
})();
</script>



</body>
</html>
